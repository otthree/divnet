# divNet: Diverging 3D CNN for CR Operationalization

Backbone model:

> Khagi, B., & Kwon, G. R. (2020). 3D CNN Design for the Classification of Alzheimer's Disease Using Brain MRI and PET. *IEEE Access*, 8, 217830–217847.

## Architecture

Diverging kernel sizes (3 → 5 → 7 → 9) across four convolutional blocks:

| Block | Kernel | Stride | Pool | Output Size |
|-------|--------|--------|------|-------------|
| 1 | 3×3×3 | 1 | 2×2×2 | 96³ |
| 2 | 5×5×5 | 2 | 2×2×2 | 24³ |
| 3 | 7×7×7 | 2 | 2×2×2 | 6³ |
| 4 | 9×9×9 | 1 | 2×2×2 | 3³ |

Classifier: Flatten(1728) → FC(512) → FC(100) → FC(3)

- Input: `[B, 1, 192, 192, 192]` preprocessed MRI volumes
- Output: `[B, 3]` logits for CN / MCI / AD (discordant predictions → CR candidates)

## Data Structure

```
data/
├── 3D_tensors/
│   ├── CN/
│   │   ├── {pt_index}.pt
│   │   └── ...
│   ├── MCI/
│   │   └── ...
│   └── AD/
│       └── ...
└── csv_splits/
    └── all_mri_scan_list.csv
```

Each `.pt` file is a float32 tensor of shape `[1, 192, 192, 192]`, generated by `3D Tensor Creation_Custom.py` from NIfTI MRI volumes. Filenames are integer indices (`pt_index`) that map back to ADNI subject/image IDs via `all_mri_scan_list.csv`.

## Setup

```bash
pip install -r requirements.txt
```

## Usage

### Train (single split)

Standard train/val/test split training. Evaluates best model on test set at the end and saves a test confusion matrix plot.

```bash
python3 divnet_train.py --config divnet_config.yaml
```

### 5-Fold Cross-Validation

Runs patient-stratified 5-fold CV. Each fold saves its own best checkpoint and confusion matrix plot (`fold_0_confusion_matrix.png` ... `fold_4_confusion_matrix.png`) under `<checkpoint_dir>/figures/`.

```bash
python3 divnet_train.py --config divnet_config.yaml --kfold
```

### Test only (with saved checkpoint)

Loads a checkpoint and evaluates on both validation and test sets. Saves confusion matrix plots for each.

```bash
python3 divnet_train.py --config divnet_config.yaml --test
python3 divnet_train.py --config divnet_config.yaml --test --resume checkpoints/divnet/best_balanced_acc.pth
```

### CR Candidate Inference

Reproduces the same 5-fold splits, loads each fold's best checkpoint, and identifies subjects whose predictions are discordant with their true labels (Cognitive Reserve candidates).

```bash
python3 divnet_inference.py --config divnet_config.yaml
python3 divnet_inference.py --config divnet_config.yaml --scan_csv csv_splits_all_mri_scan_list.csv
```

CR Groups:
- **Group 1**: True CN → Predicted MCI
- **Group 2**: True MCI → Predicted AD
- **Group 3**: True CN → Predicted AD

Results are saved to `<checkpoint_dir>/inference_results.txt`.

### 3D Tensor Preprocessing

Converts NIfTI MRI volumes to preprocessed `.pt` tensors (pad to 256³, resize to 192³).

```bash
python3 "3D Tensor Creation_Custom.py"
```

### GPU selection

```bash
python3 divnet_train.py --config divnet_config.yaml --gpu 0
```

## Configuration

All hyperparameters are in `divnet_config.yaml`:

| Section | Parameter | Default |
|---------|-----------|---------|
| data | batch_size / val_batch_size | 2 / 1 |
| data | train / val / test ratio | 0.70 / 0.15 / 0.15 |
| data | scan_csv | Path to scan list CSV (pt_index → patient_id mapping) |
| data | exclude_csv | Path to CR detected patients CSV (excluded from training) |
| model | num_filters | 64 |
| model | dropout1 / dropout2 | 0.5 / 0.3 |
| training | optimizer | SGD (Adam also supported) |
| training | lr | 0.001 |
| training | lr_milestones | [30, 60, 80] |
| training | grad_clip | 1.0 |
| training | early_stopping_patience | 20 |
| cross_validation | k_folds | 5 |
| wandb | project / enabled | DivNet CR Operationalization / true |

## Key Features

- **Patient-level splitting**: Splits by subject ID to prevent data leakage across train/val/test sets
- **CR patient exclusion**: Optionally excludes previously identified CR patients via CSV (`scan_csv` + `exclude_csv`)
- **Class-balanced training**: Weighted random sampler + weighted cross-entropy loss
- **Data augmentation**: Gaussian noise and random intensity shift (training only)
- **Multi-metric checkpointing**: Saves best models by accuracy, balanced accuracy, macro AUC, and lowest loss
- **Early stopping**: Based on validation loss with configurable patience
- **CR candidate inference**: Identifies discordant prediction subjects across 5-fold CV as cognitive reserve candidates
- **Confusion matrix plots**: Automatically saved as PNG heatmaps under `<checkpoint_dir>/figures/`
- **W&B logging**: Training/validation metrics logged to Weights & Biases

## Files

| File | Description |
|------|-------------|
| `divnet_model.py` | DivNet model architecture |
| `divnet_dataset.py` | Dataset, data loading, patient-level splitting, CR exclusion |
| `divnet_train.py` | Training, k-fold CV, and evaluation script |
| `divnet_inference.py` | 5-fold inference for CR candidate identification |
| `3D Tensor Creation_Custom.py` | NIfTI → 192³ `.pt` tensor preprocessing |
| `divnet_config.yaml` | Hyperparameter configuration |
| `requirements.txt` | Python dependencies |